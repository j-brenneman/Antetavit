(function(g){g.execute(function(){g.when("A","a-modal-factory","pldn-dynamic-campaign","pldn-log","PaladinHistoryModifier","ready").register("PaladinDynamicCampaign",function(b,e,a,c,d){if(a){var f=b.$("#pldn-dynamic-modal-displayed");if(f.val()==="0"){f.val(1);f=b.$('<span style="display:none;"></span>');b.$("body").append(f);var i=e.create(f,a),o=function(){var c=i.getContent().find(".opt-out:checked");c.length>0&&(b.ajax("/gp/ch/campaign/opt-out/ref="+a.optOutRef,{method:"post",params:{campaign:a.campaign,
creativeTreatment:a.creativeTreatment}}),b.trigger("pldn:campaign:opt-out",{popover:i,optElement:c}))};b.on("a:popover:show:"+a.name,function(c){i.$container.delegate(".dismiss","click",function(c){b.$(this).attr("name")&&i.attrs("close",a.dismissRef.replace("{{name}}",b.$(this).attr("name")));b.$(this).hasClass("opt-out-link")&&(b.ajax("/gp/ch/campaign/opt-out/ref="+a.optOutRef,{method:"post",params:{campaign:a.campaign,creativeTreatment:a.creativeTreatment}}),b.trigger("pldn:campaign:opt-out",{popover:i,
optElement:b.$(this)}));i.hide();c.preventDefault();c.stopPropagation();return!1}).delegate("a","click",function(){b.trigger("pldn:campaign:link",{popover:i,link:b.$(this)});o()});a.modalCSSClass&&c.popover.$popover.addClass(a.modalCSSClass);b.ajax("/gp/ch/campaign/count/ref="+a.countRef,{method:"post",params:{campaign:a.campaign,creativeTreatment:a.creativeTreatment}});d.pushState({modalShown:!0},null,"mdlOpen")});var m=b.$.Deferred();b.on("a:popover:dismiss:"+a.name,function(){a.disButtonRef&&i.attrs("close",
a.disButtonRef);b.off("a:popover:dismiss:"+a.name)});b.on("a:popover:afterHide:"+a.name,function(){var c=i.attrs("close")||a.dismissRef.replace("{{name}}","dbg");b.ajax("/gp/charity/ajax/track/ref="+c,{method:"post",params:{campaign:a.campaign,creativeTreatment:a.creativeTreatment}});o();d.cleanup()});var j=b.state("pldn-campaign-airy-player");j&&g.when("Airy").execute("initAiryPlayer",function(a){var d=i.$container.find(".video-player"),p;if(!j.streamingUrls)j.streamingUrls=[d.data("video-url")],
j.slateImages={preloadSlate:d.data("slate-image")};j.shouldStartHidden=!0;j.parentElement=d.get(0);p=a.embed(j);m.then(function(){p.show()});b.each("loadvideo,play,pause,replay,seek,ended,primary.viewedDuration,fullscreen,normalscreen,audioon,audiooff,changevolume,decodeerror,networkerror,undefinederror,videounsupported".split(","),function(b){p.bind(b,c.event("airy",b))})});i.attrs("data",a);a.modalCSSClass&&b.off("a:popover:afterHide:"+a.name,function(b){setTimeout(function(){b.popover.$popover.removeClass(a.modalCSSClass)},
500)});b.on("a:popover:show:"+a.name,function(){m.resolve()});d.onChange(function(){a.backDismissRef&&i.attrs("close",a.backDismissRef);i.hide()});a.autoShow&&i.show();return i}}});g.when("A").execute(function(b){function e(b){l.find("#shareSmileSubmitButton")[b?"removeClass":"addClass"]("a-button-disabled").find(".a-button-text")[b?"removeAttr":"attr"]("disabled","disabled")}function a(){function a(){c.select();c.unbind("click",a)}var c=b.$("#shareSmileRecipients");b.capabilities.textareaPlaceholder||
(c.val(j.messageDefault),c.click(a))}function c(a){var a=a.replace(/[,;]\s*/g,", "),a=a.replace(/^(,|;|\s)+/,""),a=a.replace(/(,|;|\s)+$/,""),a=b.$.trim(a),a=a.split(/[,;\s]+/),c=[];b.each(a,function(a){a=b.$.trim(a);a!==""&&c.indexOf(a)<0&&c.push(a)});return c}function d(a){var d=[];a&&(a=c(a),b.each(a,function(b){b.match(/^[_a-zA-Z0-9\-+]+(\.[_a-zA-Z0-9\-+]+)*@[a-zA-Z0-9\-+]+(\.[a-zA-Z0-9\-+]+)*(\.[a-zA-Z]{2,4})$/)||d.push(b)}));return d}function f(a){e(!0);l.find("#share_smile_error_box_text").html(a);
l.find("#share_smile_error_box").show();b.$(window).resize()}function i(a){e(!0);l.find(".a-popover-inner .shareSmileModalContent").html(a);l.find("#shareSmileSuccessBox").length>0&&b.delay(function(){l.find("div .a-button-close").click();b.delay(function(){m()},1E3)},1E3)}function g(a){e(!0);(a=b.$(a.responseText))&&a.find(".responseText").length>0&&f(a.find(".responseText").text())}function m(){n?l.find(".shareSmileModalContent").html(n):n=l.find(".shareSmileModalContent").html();b.$("#share_smile_error_box").hide();
e(!0)}var j={emailLimit:10,noRecipient:"No Recipients",maxRecipients:"Max Recipients: 10",messageDefault:"Email addresses will be stored in your recently used contacts and will not be used for marketing purposes.",badAddress:"Bad Address",error:"Config Error",url:"/gp/charity/emails/taf/send-email.html",refTag:"smi_em_pop",link:function(b){return this.url.replace(/_COUNT_/,b)}},l,n;b.declarative("share_smile_submit","submit",function(a){a.$event.preventDefault();b.$.extend(j,a.data);a=l.find("form");
if(!b.capabilities.textareaPlaceholder){var h=b.$("#shareSmileRecipients");h.val()===h.attr("placeholder")&&h.val("")}e(!1);var h=a[0].recipients.value,k=a[0].copyMe.checked;if(!h&&!k)return f(j.noRecipient),!1;k=d(h);if(k.length>0)return f(j.badAddress+"\n"+k.join(", ")),!1;if(c(h).length>j.emailLimit)return f(j.maxRecipients),!1;h=a[0];if(h.recipients){a={};k=[];if(h.recipients.value!==j.detailedInstructions&&(k=c(h.recipients.value),k.length>0))a.recipients=k.join(", ");if(h.message&&h.message.value.length>
0)a.message=h.message.value;a.ccSender=h.copyMeBox.checked?1:0;h=j.link(k.length);b.$.post(h,a,i).error(g)}});b.on("a:popover:beforeShow:share-smile-modal",function(b){l=b.popover.$popover;m();a()})});g.when("A","pldn-log","ready").register("pldn-storage",function(b,e){function a(b){this.storageKey="amazonSmile"+b.substring(0,1).toUpperCase()+b.substring(1)}a.prototype.log=function(b,a){a=a||{};a.key=this.storageKey;e.log("PaladinStorage",b,a)};a.prototype.error=function(b,a){this.log("error",{call:b,
data:a})};a.prototype.getValue=function(){if(!b.capabilities.localStorage)return this.log("localStorageUnavailable"),{};try{return!localStorage[this.storageKey]?{}:b.parseJSON(localStorage[this.storageKey])}catch(a){return this.error("get"),{}}};a.prototype.setValue=function(a){if(b.capabilities.localStorage)try{localStorage[this.storageKey]=JSON.stringify(a)}catch(d){d("save",a)}else this.log("localStorageUnavailable")};return a});g.when("A","ready").register("pldn-log",function(b){var e=b.state("pldn-log-state"),
a=function(a){return b.$.extend(a,e)},c=(new Date).getTime(),d=window.ue;d||(d=1==e.internal?{log:function(b,a,c){console.debug({info:b,channel:a,options:c})}}:{log:function(){}});var f=function(){var b=(new Date).getTime(),a=d.t0||c,f=(new Date(e.serverDateTime)).getTime();return(new Date(b-a+f)).toUTCString()};return{event:function(b,c){return function(e,j){d.log(a({eventType:b,eventName:c,eventDateTime:f(),eventContext:j}),"paladin")}},log:function(c,e,g){c=b.$.extend({},{eventType:c,eventName:e,
eventDateTime:f()});if(g)c.eventData=g;d.log(a(c),"paladin")}}});g.when("A","pldn-log","pldn-storage","ready").register("SmileCampaign",function(b,e,a){function c(b,a,c){this.date=b?new Date(b):new Date;this.date.setSeconds(0);this.date.setMinutes(0);this.date.setHours(0);this.redirect=!!a;this.optOut=!!c}function d(b){this.campaigns={};b&&this.extend(b)}function f(b){var a=new d;a.addCampaign({hits:[],optOut:!1},b);return a}function i(a){var d=this;this.campaignType=a.campaignType;this.logType="SmileCampaign-"+
this.campaignType;var i=b.$.extend({},g,a.campaignConfig),p=function(b){e.log(d.logType,b?"show":"noshow");return a.callback&&typeof a.callback=="function"&&a.callback(b)||b};if(b.capabilities.localStorage){var h=f(this.campaignType);h.extend(m.getValue());this.campaign=h.campaigns[this.campaignType];if(this.campaign.optOut)p(!1);else{var k=i.showOnFirstHit;if(this.campaign.hits.length>0){var k=this.campaign.hits.length-i.showOnFirstHit?0:1,q=this.campaign.hits[this.campaign.hits.length-1].date,r=
i.resetDeltaDays*864E5;q&&q<new Date-r?(k=!0,this.campaign.hits=[]):k=q<new Date-i.redisplayDeltaDays*864E5&&k<i.maxDisplays;if(k)this.currentHit=new c(new Date,!1,!1),this.campaign.hits.push(this.currentHit)}else this.currentHit=new c(new Date,!1,!1),this.campaign.hits.push(this.currentHit),e.log(this.logType,"noLocalHistory");m.setValue(h.campaigns);p(k)}}else m.log("localStorageUnavailable"),p(i.showOnFirstHit)}var g={maxDisplays:3,redisplayDeltaDays:7,resetDeltaDays:90,showOnFirstHit:!1},m=new a("campaigns");
d.prototype.addCampaign=function(a,d){this.campaigns[d]={optOut:!!a.optOut,hits:b.$.isArray(a.hits)?b.map(a.hits,function(b){return new c(b.date,b.redirect,b.optOut)}):[]}};d.prototype.extend=function(a){var c=this;b.each(a,function(b,a){c.addCampaign(b,a)})};i.prototype.customerResponse=function(b){b=b||{};e.log(this.logType,"response",b);this.currentHit?(this.currentHit.redirect=!!b.redirect,this.currentHit.optOut=!!b.optOut):(this.currentHit=new c(new Date,!!b.redirect,!!b.optOut,!0),this.campaign.hits.push(this.currentHit));
if(b.optOut)this.campaign.optOut=!!b.optOut;var a=f(this.campaignType);a.extend(m.get("campaigns"));a.campaigns[this.campaignType]=this.campaign;m.setValue(a.campaigns);return b.callback&&typeof b.callback=="function"&&b.callback()};return i});g.when("PaladinDynamicCampaign","SmileCampaign").execute("pldn-ucol-check",function(b,e){function a(a){a&&b.show()}if(b){var c=b.attrs("data");c.autoShow||new e({campaignType:c.campaign,campaignConfig:c.campaignConfig||{},callback:a})}});g.when("A").register("PldnCampaignTracker",
function(b){function e(a,c){var d={};b.each(c,function(b){d[b]=a[b]});return d}return{track:function(a,c){b.ajax("/gp/charity/ajax/track.html/ref="+a,{method:"post",params:e(c,"campaign,creativeTreatment,customer_id,session_id,request_id,domain,server,ubid,page_type,sub_page_type,internal,prime".split(","))})}}});g.when("A","jQuery").register("PaladinHistoryModifier",function(b,e){var a=0,c,d,f;e(window).bind("popstate",function(){a--});window.history&&window.history.pushState?(c=function(c,d){b.equals(window.history.state,
c)||window.history.pushState(c,d,null);a++},d=function(b){e(window).bind("popstate",b)},f=function(){a>0&&window.history.go(-a)}):c=d=f=function(){};return{pushState:c,onChange:d,cleanup:f}});g.when("A","ready").execute("pldn-load-dynamic-campaign",function(b){b.state("pldn-dynamic-campaign")&&g.register("pldn-dynamic-campaign",function(){return b.state("pldn-dynamic-campaign")})})})})(function(){var g=window.AmazonUIPageJS||P,b=g.attributeErrors;return b?b("AmazonSmileAUIAssets"):g}());